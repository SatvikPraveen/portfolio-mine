<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Resume Viewer</title>

    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 25px;
        background-color: #f9fafb;
        color: #333;
      }
      h2, h3 {
        color: #222;
        margin-bottom: 10px;
      }
      label {
        margin-right: 8px;
        font-weight: 500;
      }
      select {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        font-size: 14px;
      }
      pre {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 8px;
        max-width: 100%;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      iframe {
        width: 100%;
        height: 900px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
      }
      .section { margin-bottom: 40px; }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .photo-wrapper {
        text-align: center;
        margin: 20px 0;
      }
      .photo-wrapper img {
        border-radius: 50%;
        width: 120px;
        height: 120px;
        border: 3px solid #ccc;
        box-shadow: 0 0 8px rgba(0,0,0,0.1);
      }
    </style>
  </head>

  <body>
    <div class="section">
      <h2>Extracted Resume Data (from PDF)</h2>

      <script type="module">
        import * as pdfjsLib from './pdf.mjs';
        const url = './shanmuga-priya-resume.pdf';
        pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';
        const loadingTask = pdfjsLib.getDocument(url);

        loadingTask.promise.then(pdf => {
          const textPromises = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            textPromises.push(
              pdf.getPage(i).then(page =>
                page.getTextContent().then(content =>
                  content.items.map(item => item.str).join(' ')
                )
              )
            );
          }
          Promise.all(textPromises).then(pages => {
            const fullText = pages.join('\n\n');
            const name = fullText.match(/^[A-Za-z\s]+/g)?.[0]?.trim() || '';
            const email =
              fullText.match(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/)?.[0] || '';
            const linkedin =
              fullText.match(/linkedin\.com\/[A-Za-z0-9\/\-\._]+/i)?.[0] || '';
            const jsonData = { name, email, linkedin };
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(jsonData, null, 2);
            document.body.appendChild(pre);
          });
        });
      </script>
    </div>
    <div class="section">
      <h3>Preview JSON Résumé Themes</h3>

      <div class="row">
        <label for="jsonSelect">Data:</label>
        <select id="jsonSelect">
          <option value="simple.json">simple.json</option>
          <option value="detailed.json">detailed.json</option>
        </select>

        <label for="theme" style="margin-left:12px;">Theme:</label>
        <select id="theme">
          <option value="elegant">Elegant</option>
          <option value="flat">Flat</option>
          <option value="even">Even</option>
          <option value="professional">Professional</option>
          <option value="macchiato">Macchiato</option>
          <option value="kendall">Kendall</option>
          <option value="minimalist-grid">Minimalist Grid</option>
          <option value="executive-slate">Executive Slate</option>
          <option value="creative-studio">Creative Studio</option>
          <option value="data-driven">Data-Driven</option>
          <option value="pumpkin">Pumpkin</option>
          <option value="modern-classic">Modern Classic</option>
        </select>
      </div>

      <div style="margin: 15px 0;"></div>

      <pre id="dataPreview">Loading JSON…</pre>

      <div class="photo-wrapper">
        <img id="gravatarPhoto" alt="Profile Photo" src="" />
        <div style="font-size:13px;color:#555;">Bio photo (via Gravatar)</div>
      </div>

      <iframe id="themePreview" title="JSON Resume Theme Preview"></iframe>
      <div id="dataStatus" style="margin-top:8px;font:13px/1.4 system-ui;"></div>

      <script>
        const $ = (sel) => document.querySelector(sel);
        const jsonSelect   = $("#jsonSelect");
        const themeSelect  = $("#theme");
        const dataPreview  = $("#dataPreview");
        const previewFrame = $("#themePreview");
        const statusBox    = $("#dataStatus");
        const registryBase = "https://registry.jsonresume.org/thomasdavis?theme=";

        const themeCache = new Map();

        function getParam(name, fallback) {
          const v = new URLSearchParams(location.search).get(name);
          return v ?? fallback;
        }
        function setParamInURL(params) {
          const url = new URL(location.href);
          Object.entries(params).forEach(([k,v])=>{
            if(v==null)url.searchParams.delete(k); else url.searchParams.set(k,v);
          });
          history.replaceState(null,"",url.toString());
        }

        async function loadJson(file) {
          try {
            const res = await fetch(file, { cache: "no-store" });
            if (!res.ok) throw new Error(res.statusText);
            const json = await res.json();
            dataPreview.textContent = JSON.stringify(json, null, 2);
            statusBox.textContent = `Loaded ${file} — ${Object.keys(json).length} sections`;
            return json;
          } catch (e) {
            dataPreview.textContent = `Failed to load ${file}`;
            statusBox.textContent = "JSON load failed";
            return null;
          }
        }

        async function loadTheme(themeName) {
          const url = registryBase + encodeURIComponent(themeName);
          const start = performance.now();
          if (themeCache.has(url)) {
            previewFrame.src = themeCache.get(url);
            const duration = performance.now() - start;
            statusBox.textContent = `Theme "${themeName}" loaded from cache in ${duration.toFixed(1)} ms`;
            return;
          }
          const preloader = document.createElement("iframe");
          preloader.style.display = "none";
          preloader.src = url;
          preloader.onload = () => {
            themeCache.set(url, url);
            previewFrame.src = url;
            const duration = performance.now() - start;
            statusBox.textContent = `Theme "${themeName}" loaded in ${duration.toFixed(1)} ms`;
            preloader.remove();
          };
          document.body.appendChild(preloader);
        }

        async function loadAll(jsonFile, themeName) {
          await loadJson(jsonFile);
          await loadTheme(themeName);
        }

        function initFromURL() {
          const jsonFile  = getParam("data","simple.json");
          const themeName = getParam("theme","elegant");
          jsonSelect.value  = jsonFile;
          themeSelect.value = themeName;
          loadAll(jsonFile, themeName);
        }

        jsonSelect.addEventListener("change",()=>{
          setParamInURL({data:jsonSelect.value,theme:themeSelect.value});
          loadAll(jsonSelect.value, themeSelect.value);
        });
        themeSelect.addEventListener("change",()=>{
          setParamInURL({data:jsonSelect.value,theme:themeSelect.value});
          loadAll(jsonSelect.value, themeSelect.value);
        });

        initFromURL();
        function md5(str) {
          return CryptoJS.MD5(str.trim().toLowerCase()).toString();
        }

        async function loadGravatar(email) {
          const hash = md5(email);
          const url = `https://www.gravatar.com/avatar/${hash}?s=200&d=identicon`;
          $("#gravatarPhoto").src = url;
        }
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js";
        script.onload = () => loadGravatar("shanmugapriyakannan019@gmail.com");
        document.body.appendChild(script);
      </script>
    </div>
    <div class="section">
      <h3>Project Notes (from README.md)</h3>
      <div id="readmeContent" style="
        background:#fff;border:1px solid #ddd;border-radius:8px;
        padding:20px;max-width:100%;line-height:1.6;
        font-family:system-ui,sans-serif;color:#222;">
        <em>Loading README.md...</em>
      </div>

      <script>
        function markdownToHtml(md) {
          return md
            .replace(/^### (.*$)/gim,'<h3>$1</h3>')
            .replace(/^## (.*$)/gim,'<h2>$1</h2>')
            .replace(/^# (.*$)/gim,'<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/gim,'<strong>$1</strong>')
            .replace(/\*(.*?)\*/gim,'<em>$1</em>')
            .replace(/\[(.*?)\]\((.*?)\)/gim,'<a href="$2" target="_blank">$1</a>')
            .replace(/\n$/gim,'<br />');
        }
        async function loadReadme(){
          const c=document.getElementById("readmeContent");
          try{
            const r=await fetch("./README.md",{cache:"no-store"});
            if(!r.ok)throw new Error(r.statusText);
            const t=await r.text(); c.innerHTML=markdownToHtml(t);
          }catch(e){
            c.innerHTML="<p style='color:red;'> README.md not found or failed to load.</p>";
          }
        }
        loadReadme();
      </script>
    </div>
  </body>
</html>
